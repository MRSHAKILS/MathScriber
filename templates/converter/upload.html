{% extends 'base.html' %}

{% block title %}Upload Images - MathScriber{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <h1 class="text-center mb-4">Upload Images for LaTeX Conversion</h1>
        
        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="upload-form">
                    {% csrf_token %}
                    
                    <!-- Task Selection -->
                    <div class="mb-3">
                        <label for="{{ form.task.id_for_label }}" class="form-label">
                            <strong>Content Type:</strong>
                        </label>
                        {{ form.task }}
                        <div class="form-text">{{ form.task.help_text }}</div>
                    </div>
                    
                    <!-- File Upload Area -->
                    <div class="mb-3">
                        <label for="images" class="form-label">
                            <strong>Select Images:</strong>
                        </label>
                        <div class="upload-area" id="upload-area">
                            <i class="bi bi-cloud-upload" style="font-size: 2rem; color: #6c757d;"></i>
                            <p class="mt-2 mb-2">Drag and drop images here or click to select</p>
                            <p class="text-muted">You can select multiple images at once</p>
                            <input type="file" name="images" id="images" multiple accept="image/*" style="display: none;">
                        </div>
                        <div class="form-text">Select multiple images to convert to LaTeX</div>
                    </div>
                    
                    <!-- Image Preview Area -->
                    <div id="preview-container" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0"><strong>Selected Images:</strong></label>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllFiles()">
                                <i class="bi bi-trash"></i> Clear All
                            </button>
                        </div>
                        <div id="image-previews"></div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn" disabled>
                            <i class="bi bi-magic"></i> Convert to LaTeX
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Recent Uploads -->
        {% if recent_uploads %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Recent Uploads</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for upload in recent_uploads %}
                    <div class="col-md-3 mb-3" data-upload-id="{{ upload.id }}">
                        <div class="card position-relative">
                            <button type="button" class="btn btn-danger btn-sm position-absolute" 
                                    style="top: 5px; right: 5px; z-index: 10;" 
                                    onclick="deleteUpload({{ upload.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                            <img src="{{ upload.image.url }}" class="card-img-top" style="height: 150px; object-fit: cover;">
                            <div class="card-body p-2">
                                <small class="text-muted">{{ upload.task|title }}</small>
                                <br>
                                <small class="text-muted">{{ upload.created_at|date:"M d, H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('images');
    const uploadArea = document.getElementById('upload-area');
    const previewContainer = document.getElementById('preview-container');
    const imagePreviewsDiv = document.getElementById('image-previews');
    const submitBtn = document.getElementById('submit-btn');
    
    let selectedFiles = [];
    
    // File input change handler
    fileInput.addEventListener('change', function(e) {
        // Add new files to existing selection instead of replacing
        const newFiles = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
        selectedFiles = selectedFiles.concat(newFiles);
        updateFileInput();
        showPreviews();
        updateSubmitButton();
    });
    
    // Drag and drop handlers
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const newFiles = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
        if (newFiles.length === 0) {
            alert('Please drop valid image files.');
            return;
        }
        
        // Add dropped files to existing selection
        selectedFiles = selectedFiles.concat(newFiles);
        updateFileInput();
        showPreviews();
        updateSubmitButton();
    });
    
    uploadArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    function updateFileInput() {
        // Create a new file list with selected files
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }
    
    function showPreviews() {
        imagePreviewsDiv.innerHTML = '';
        
        if (selectedFiles.length === 0) {
            previewContainer.style.display = 'none';
            return;
        }
        
        previewContainer.style.display = 'block';
        
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'preview-container';
                previewDiv.innerHTML = `
                    <img src="${e.target.result}" class="image-preview" alt="Preview">
                    <button type="button" class="remove-btn" onclick="removeFile(${index})">&times;</button>
                    <div class="text-center mt-1">
                        <small class="text-muted">${file.name}</small>
                    </div>
                `;
                imagePreviewsDiv.appendChild(previewDiv);
            };
            reader.readAsDataURL(file);
        });
    }
    
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileInput();
        showPreviews();
        updateSubmitButton();
    };
    
    function updateSubmitButton() {
        submitBtn.disabled = selectedFiles.length === 0;
        if (selectedFiles.length > 0) {
            submitBtn.innerHTML = `<i class="bi bi-magic"></i> Convert ${selectedFiles.length} Image(s) to LaTeX`;
        } else {
            submitBtn.innerHTML = '<i class="bi bi-magic"></i> Convert to LaTeX';
        }
    }
    
    // Add clear all button functionality
    window.clearAllFiles = function() {
        selectedFiles = [];
        fileInput.value = '';
        showPreviews();
        updateSubmitButton();
    };
    
    // Form submission with loading state
    document.getElementById('upload-form').addEventListener('submit', function() {
        if (selectedFiles.length > 0) {
            submitBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Processing...';
            submitBtn.disabled = true;
        }
    });
});

// Delete upload function
async function deleteUpload(uploadId) {
    if (!confirm('Are you sure you want to delete this upload?')) {
        return;
    }
    
    try {
        const response = await fetch(`/delete/${uploadId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        });
        
        if (response.ok) {
            // Remove the card from the DOM
            const card = document.querySelector(`[data-upload-id="${uploadId}"]`);
            if (card) {
                card.remove();
            }
            // Reload the page to refresh the recent uploads
            location.reload();
        } else {
            alert('Error deleting upload. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting upload. Please try again.');
    }
}
</script>
{% endblock %}